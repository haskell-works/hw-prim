machine:
  environment:
    CABAL_INSTALL_FLAGS: |
        -j
        --force-reinstalls
        --upgrade-dependencies
        --disable-library-profiling
        --disable-executable-profiling
        --disable-documentation
        --disable-library-coverage
        --disable-benchmarks
  post:
    - curl https://nixos.org/nix/install | sh

dependencies:
  cache_directories:
    - "~/.cabal"
    - "~/.ghc"
  pre:
    - cp ./nox ~/bin/nox
    - nox nix-env -i ghc-7.10.3
    - nox nix-env -i cabal-install-1.22.9.0
    - nox cabal update
    - nox cabal install -j $CABAL_INSTALL_FLAGS --only-dependencies
    - nox cabal install -j $CABAL_INSTALL_FLAGS --only-dependencies --enable-tests
    - nox cabal install -j $CABAL_INSTALL_FLAGS --only-dependencies --enable-benchmarks
    - nox cabal install -j --force-reinstalls --reinstall hspec-discover
    - ln -sf ~/.cabal/bin/hspec-discover ~/bin/hspec-discover
  override:
    - nox cabal build -j
test:
  override:
    - nox cabal test

deployment:
  release_branch:
    owner: haskell-works
    branch: /v.*/
    commands:
      - nox ./scripts/autotag.sh

  hackage:
    owner: haskell-works
    tag: /v.*/
    commands:
      - nox ./scripts/publish.sh
